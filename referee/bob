#!/bin/sh

set -eu

C="\e[92m"
R="\e[0m"

quiet=false
image_name="flask-chess-referee"
container_name="chess-referee"
referee_port=5001

[ -f ../PASSWORD ] && cat ../PASSWORD | sudo -S -v

# Check if the referee image exists, build if not
if ! sudo docker images | grep -q "$image_name"; then
    printf "${C}%s${R}\n" "Building image $image_name"
    sudo docker build -t "$image_name" .
else
    printf "${C}%s${R}\n" "Image $image_name exists. Skipping build."
fi

# Handle any existing referee container
printf "${C}%s${R}\n" "Dealing with existing $container_name container"
if sudo docker ps -a | grep -q "$container_name"; then
    sudo docker stop "$container_name" && sudo docker rm "$container_name"
    printf "${C}%s${R}\n" "Stopped and removed existing $container_name container"
fi

# Run the referee container
printf "${C}%s${R}\n" "Running $container_name container"
sudo docker run -d --name "$container_name" -p "$referee_port:$referee_port" "$image_name"

# Check if the referee service is accessible
printf "${C}%s${R}\n" "Checking referee service availability..."
sleep 1
while ! curl -s "http://localhost:$referee_port/check_move" > /dev/null; do
    printf "${C}%s${R}\n" "Referee service is not ready yet, waiting..."
    sleep 1  # wait before rechecking
done

# Quick check for referee service
if ! $quiet; then
    printf "${C}%s${R}\n" "Referee service is up and running at http://localhost:$referee_port/"
    curl -X POST "http://localhost:$referee_port/check_move" -H "Content-Type: application/json" -d '{"from": "e2", "to": "e4"}'
fi

printf "${C}%s${R}\n" "Referee service setup complete!"

